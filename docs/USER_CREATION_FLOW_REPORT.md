# User Creation Flow Investigation Report

**Date:** February 5, 2026  
**Subject:** Complete Trace of User Creation and Key Synchronization Flow  
**Purpose:** Document the end-to-end flow of user creation between WordPress and the ACM2 backend, explain the key mismatch issue, and identify the root cause of "No ACM2 Account" errors.

---

## Executive Summary

This report traces the complete flow of user creation from WordPress registration through backend account creation. The investigation revealed that new users created after February 5, 2026 at 04:57 UTC were unable to sync with the backend due to a **plugin secret mismatch** between the WordPress database and the backend server.

---

## Part 1: System Architecture Overview

### Two-Server Architecture

1. **Frontend Server (16.145.206.59)**
   - Bitnami WordPress on AWS Lightsail
   - Hosts the ACM WordPress Plugin
   - MariaDB database: `bn_wordpress`

2. **Backend Server (54.71.183.56 / api.apicostx.com)**
   - FastAPI Python application
   - SQLite databases per user
   - Handles API key generation and provider key storage

### Three Types of Keys in the System

1. **Plugin Secret** (`sk_plugin_...`)
   - A shared secret between WordPress and the backend
   - Used to authenticate WordPress when it creates users on the backend
   - Must match exactly on both servers

2. **ACM2 API Key** (`acm2_{uuid}_{random}`)
   - Generated by the backend for each user
   - Stored encrypted in WordPress database
   - Used by the React frontend to authenticate API requests

3. **Provider API Keys** (OpenAI, Anthropic, etc.)
   - Per-user keys stored in backend SQLite databases
   - Not relevant to this investigation

---

## Part 2: User Creation Flow (Step-by-Step Trace)

### Step 1: WordPress User Registration

When a new user registers on WordPress, the `user_register` hook fires.

**File:** `/opt/bitnami/wordpress/wp-content/plugins/acm-wordpress-plugin/includes/class-user-sync.php`

The `ACM2_User_Sync` class has a constructor that registers:
```
add_action('user_register', array($this, 'sync_new_user'), 10, 1)
```

This means the `sync_new_user` method is called immediately after a new WordPress user is created.

### Step 2: UUID Generation

**File:** `class-user-sync.php` → `sync_new_user()` method

The method first generates a UUID for the new user by calling `acm2_get_user_uuid($user_id)`.

**File:** `acm2-integration.php` → `acm2_get_user_uuid()` function

This function:
1. Checks if the user already has a UUID stored in `wp_usermeta` under the key `_acm2_uuid`
2. If no UUID exists, generates a new one using `wp_generate_uuid4()`
3. Stores the UUID in `wp_usermeta` using `update_user_meta()`
4. Returns the UUID

### Step 3: Retrieving the Plugin Secret

**File:** `acm2-integration.php` → `acm2_get_plugin_secret()` function

Before calling the backend, WordPress needs the plugin secret. This function:
1. First checks if the constant `ACM2_PLUGIN_SECRET` is defined in `wp-config.php`
2. If not, retrieves it from `wp_options` table under key `acm2_plugin_secret`
3. If neither exists, generates a new random secret and stores it in `wp_options`

**Critical Finding:** The plugin has a fallback that generates a random secret if none is found. This is where the mismatch originated.

### Step 4: Calling the Backend API

**File:** `class-user-sync.php` → `sync_new_user()` method

The method makes an HTTP POST request to the backend:

- **Endpoint:** `https://api.apicostx.com/api/v1/users`
- **Method:** POST
- **Headers:**
  - `Content-Type: application/json`
  - `X-ACM2-Plugin-Secret: {the plugin secret}`
- **Body:** JSON containing:
  - `uuid`: The generated UUID
  - `email`: User's email
  - `wordpress_user_id`: The WordPress user ID

### Step 5: Backend Authentication

**File (Backend):** `acm2/app/auth/middleware.py`

When the request arrives at the backend, the authentication middleware checks the `X-ACM2-Plugin-Secret` header:

1. Extracts the header value
2. Compares it against `settings.acm2_plugin_secret` loaded from `.env`
3. If mismatch: Returns HTTP 401 "Invalid plugin secret"
4. If match: Allows the request to proceed

**File (Backend):** `acm2/app/config.py`

The settings class loads `ACM2_PLUGIN_SECRET` from the environment file:
- Expected value: `sk_plugin_8f545de3ddba1cb7c2b7205cbef0c32485df0c41ab779c003d02c1c8454566fb`

### Step 6: User Creation on Backend (If Authentication Succeeds)

**File (Backend):** `acm2/app/api/routes/users.py` → `create_user()` endpoint

If the plugin secret is valid:

1. Validates the UUID format
2. Creates a new SQLite database for the user at path `user_{uuid}.db`
3. Initializes the database schema (cost tables, API keys table, provider keys table)
4. Generates a new API key using the key generation service

### Step 7: API Key Generation

**File (Backend):** `acm2/app/auth/api_keys.py` → `generate_api_key()` function

The API key is generated in format: `acm2_{uuid}_{random_hex}`

1. Creates a 32-character random hex suffix
2. Combines with prefix and UUID: `acm2_{uuid}_{random}`
3. Creates a bcrypt hash of the key for storage
4. Stores the hash in the user's SQLite database
5. Returns the **plaintext key** (only time it's available in plaintext)

### Step 8: Response to WordPress

The backend returns JSON:
```json
{
  "uuid": "...",
  "api_key": "acm2_{uuid}_{random}",
  "message": "User created successfully"
}
```

### Step 9: Storing the API Key in WordPress

**File:** `class-user-sync.php` → `sync_new_user()` method (continuation)

Upon receiving a successful response:

1. Extracts the `api_key` from the response
2. Encrypts it using `ACM2_Key_Encryption::encrypt()`
3. Stores it in `wp_acm2_api_keys` table with columns:
   - `user_id`: WordPress user ID
   - `api_key`: Encrypted API key
   - `created_at`: Timestamp

### Step 10: API Key Encryption

**File:** `class-key-encryption.php` → `encrypt()` method

The API key is encrypted before storage using:
- Algorithm: AES-256-CBC
- Key: Derived from WordPress `AUTH_KEY` constant
- IV: Random 16 bytes, prepended to ciphertext
- Output: Base64 encoded

### Step 11: User Accesses Provider Keys Page

**File:** `class-provider-keys-page.php`

When a user visits the Provider Keys admin page:

1. The page calls `acm2_get_user_uuid()` to get the user's UUID
2. Retrieves the encrypted API key from `wp_acm2_api_keys`
3. Decrypts it using `ACM2_Key_Encryption::decrypt()`
4. Passes UUID and API key to the React app as JavaScript variables

### Step 12: React App Initialization

**File:** `class-react-app.php`

The React app is loaded with data via `wp_localize_script()`:
- `acm2_uuid`: User's UUID
- `acm2_api_key`: Decrypted API key
- `api_base_url`: Backend API URL

### Step 13: React App Makes API Calls

The React frontend uses the API key in the `X-ACM2-API-Key` header for all requests to the backend.

**File (Backend):** `acm2/app/auth/middleware.py`

For user requests (not plugin requests), the middleware:
1. Extracts `X-ACM2-API-Key` header
2. Parses the UUID from the key format
3. Loads the user's SQLite database
4. Retrieves stored key hash
5. Verifies using bcrypt
6. If valid: Sets user context and allows request

---

## Part 3: Database State Analysis

### WordPress Database Tables

**Table: `wp_usermeta`** (UUID storage)
| user_id | meta_key | meta_value |
|---------|----------|------------|
| 8 | _acm2_uuid | 14cdcea3-017c-4998-ab2d-24fcab9c68f7 |
| 9 | _acm2_uuid | generated but sync failed |
| 10 | _acm2_uuid | generated but sync failed |
| 11 | _acm2_uuid | generated but sync failed |
| 12 | _acm2_uuid | generated but sync failed |
| 13 | _acm2_uuid | generated but sync failed |

**Table: `wp_acm2_api_keys`** (API key storage)
| user_id | api_key | created_at |
|---------|---------|------------|
| 1 | encrypted_key | ... |
| 4 | encrypted_key | ... |
| 5 | encrypted_key | ... |
| 6 | encrypted_key | ... |
| 8 | encrypted_key | ... |

**Observation:** Users 9-13 have UUIDs but NO API keys. Their sync failed.

**Table: `wp_options`** (Plugin secret storage)
| option_name | option_value |
|-------------|--------------|
| acm2_plugin_secret | sk_plugin_a75fa2193a... (was randomly generated) |

### Backend Database Files

Directory: `/home/bitnami/acm2/data/`

Only one user database exists:
- `user_14cdcea3-017c-4998-ab2d-24fcab9c68f7.db` (User 8)

Users 9-13 have no corresponding backend databases because their creation requests were rejected with 401 errors.

---

## Part 4: Root Cause Analysis

### The Mismatch

| Location | Secret Value |
|----------|--------------|
| Backend `.env` | `sk_plugin_8f545de3ddba1cb7c2b7205cbef0c32485df0c41ab779c003d02c1c8454566fb` |
| WordPress `wp-config.php` | `sk_plugin_8f545de3ddba1cb7c2b7205cbef0c32485df0c41ab779c003d02c1c8454566fb` |
| WordPress `wp_options` table | `sk_plugin_a75fa2193a...` (random, different) |

### How the Mismatch Occurred

1. The plugin secret was properly configured in `wp-config.php` as a constant
2. At some point (possibly during database migration, plugin reinstall, or cache clear), the `wp_options` record was deleted or not present
3. On February 5, 2026 at 04:57 UTC, the plugin's fallback code executed
4. The fallback saw no `wp_options` entry and no constant (or failed to read the constant)
5. It generated a new random secret: `sk_plugin_a75fa2193a...`
6. This random secret was stored in `wp_options`
7. All subsequent user creations used this random secret
8. The backend rejected all requests because the secret didn't match

### Evidence from Debug Log

```
[05-Feb-2026 04:57:12 UTC] Generated new plugin secret: sk_plugin_a75fa2193a...
[05-Feb-2026 04:57:15 UTC] ACM2 API Error for user 9: 401 - {"detail":"Invalid plugin secret"}
[05-Feb-2026 04:58:01 UTC] ACM2 API Error for user 10: 401 - {"detail":"Invalid plugin secret"}
[05-Feb-2026 04:59:33 UTC] ACM2 API Error for user 11: 401 - {"detail":"Invalid plugin secret"}
```

### Why the Fallback Triggered

The `acm2_get_plugin_secret()` function has this priority order:
1. Check for `ACM2_PLUGIN_SECRET` constant (from wp-config.php)
2. Check `wp_options` table
3. Generate new random secret

The constant exists in `wp-config.php`, so normally it should be used. Possible reasons the fallback triggered:
- WordPress was not fully loaded when the function was called
- A caching issue prevented constant from being read
- The plugin was activated before wp-config.php was properly loaded
- Object cache returned stale/empty data

---

## Part 5: Affected Users

| User ID | UUID Generated | API Key Created | Backend Database | Status |
|---------|----------------|-----------------|------------------|--------|
| 1 | Yes | Yes | Yes | Working |
| 4 | Yes | Yes | Yes | Working |
| 5 | Yes | Yes | Yes | Working |
| 6 | Yes | Yes | Yes | Working |
| 8 | Yes | Yes | Yes | Working |
| 9 | Yes | **No** | **No** | **Failed - 401** |
| 10 | Yes | **No** | **No** | **Failed - 401** |
| 11 | Yes | **No** | **No** | **Failed - 401** |
| 12 | Yes | **No** | **No** | **Failed - 401** |
| 13 | Yes | **No** | **No** | **Failed - 401** |

---

## Part 6: Files Examined

### Backend Files (12 files)

1. `acm2/app/api/routes/users.py` - User creation endpoint (421 lines)
2. `acm2/app/auth/api_keys.py` - API key generation and validation (202 lines)
3. `acm2/app/auth/middleware.py` - Authentication middleware (215 lines)
4. `acm2/app/auth/user_registry.py` - In-memory user registry (215 lines)
5. `acm2/app/config.py` - Settings and configuration (~90 lines)
6. `acm2/app/db/seed_user.py` - User database seeding (294 lines)
7. `acm2/app/main.py` - FastAPI application entry (302 lines)
8. `acm2/app/api/routes/provider_keys.py` - Provider keys routes (~200 lines)
9. `acm2/.env` - Environment configuration
10. `acm2/app/db/models.py` - Database models
11. `acm2/app/db/session.py` - Session management
12. `acm2/app/api/routes/costs.py` - Cost tracking routes

### Frontend Files (10 files via SSH)

1. `acm2-integration.php` - Main plugin file with helper functions
2. `class-user-sync.php` - User synchronization with UUID generation
3. `class-react-app.php` - React app loader and configuration
4. `class-provider-keys-page.php` - Provider keys admin page
5. `class-key-encryption.php` - AES-256-CBC encryption class
6. `class-admin-menu.php` - Admin menu registration
7. `class-api-client.php` - Backend API client
8. `class-cost-display.php` - Cost display widget
9. `wp-config.php` - WordPress configuration
10. `plugin.php` - Plugin activation/deactivation

### Log Files (3 files)

1. `/opt/bitnami/wordpress/wp-content/debug.log` - WordPress debug log (full)
2. `/opt/bitnami/mariadb/logs/mysqld.log` - MariaDB logs
3. Backend application logs (via SSH)

### Database Tables Queried (5 tables)

1. `wp_options` - Plugin settings and secrets
2. `wp_usermeta` - User UUIDs
3. `wp_acm2_api_keys` - Encrypted API keys
4. `wp_users` - User accounts
5. Backend SQLite user databases

---

## Part 7: Sequence Diagram

```
┌─────────┐     ┌─────────────┐     ┌──────────────┐     ┌─────────┐
│  User   │     │  WordPress  │     │   Plugin     │     │ Backend │
└────┬────┘     └──────┬──────┘     └──────┬───────┘     └────┬────┘
     │                 │                   │                  │
     │ Register        │                   │                  │
     │────────────────>│                   │                  │
     │                 │                   │                  │
     │                 │ user_register     │                  │
     │                 │ hook fires        │                  │
     │                 │──────────────────>│                  │
     │                 │                   │                  │
     │                 │                   │ Generate UUID    │
     │                 │                   │─────────┐        │
     │                 │                   │         │        │
     │                 │                   │<────────┘        │
     │                 │                   │                  │
     │                 │                   │ Get Plugin Secret│
     │                 │                   │─────────┐        │
     │                 │                   │         │        │
     │                 │                   │<────────┘        │
     │                 │                   │                  │
     │                 │                   │ POST /api/v1/users
     │                 │                   │ X-ACM2-Plugin-Secret
     │                 │                   │─────────────────>│
     │                 │                   │                  │
     │                 │                   │                  │ Verify Secret
     │                 │                   │                  │────┐
     │                 │                   │                  │    │
     │                 │                   │                  │<───┘
     │                 │                   │                  │
     │                 │                   │   IF MISMATCH:   │
     │                 │                   │   401 Unauthorized│
     │                 │                   │<─────────────────│
     │                 │                   │                  │
     │                 │                   │   IF MATCH:      │
     │                 │                   │   Create User DB │
     │                 │                   │   Generate API Key
     │                 │                   │   Return 200 + key│
     │                 │                   │<─────────────────│
     │                 │                   │                  │
     │                 │                   │ Encrypt & Store  │
     │                 │                   │ API Key          │
     │                 │                   │─────────┐        │
     │                 │                   │         │        │
     │                 │                   │<────────┘        │
     │                 │                   │                  │
     │ Registration    │                   │                  │
     │ Complete        │                   │                  │
     │<────────────────│                   │                  │
```

---

## Part 8: Conclusions

### Root Cause

The `acm2_plugin_secret` value in the WordPress `wp_options` table did not match the `ACM2_PLUGIN_SECRET` value configured in the backend `.env` file. This caused all user sync requests to fail with HTTP 401 "Invalid plugin secret" errors.

### Why UUIDs Exist But API Keys Don't

The UUID generation happens locally in WordPress before the backend API call. When the backend rejects the request with a 401 error, the UUID has already been saved to `wp_usermeta`, but the API key (which comes from the backend response) is never received or stored.

### Why "No ACM2 Account" Appears

When a user visits the Provider Keys page:
1. The plugin looks up their API key in `wp_acm2_api_keys`
2. For users 9-13, no row exists (sync failed)
3. Without an API key, the React app cannot authenticate to the backend
4. The React app displays "No ACM2 Account" because it has no valid credentials

### Resolution Path

To fix the affected users:
1. Ensure the plugin secret in `wp_options` matches the backend `.env`
2. Trigger a re-sync for each affected user (9-13)
3. This will create their backend databases and generate API keys
4. Store the API keys in `wp_acm2_api_keys`

Alternatively, provide an admin interface to manually trigger user sync retries.

---

## Appendix A: Key Code Locations

| Function | File | Purpose |
|----------|------|---------|
| `acm2_get_user_uuid()` | acm2-integration.php | Generate/retrieve user UUID |
| `acm2_get_plugin_secret()` | acm2-integration.php | Get plugin secret with fallback |
| `sync_new_user()` | class-user-sync.php | Main sync orchestration |
| `encrypt()` / `decrypt()` | class-key-encryption.php | API key encryption |
| `create_user()` | users.py | Backend user creation endpoint |
| `generate_api_key()` | api_keys.py | Backend key generation |
| `verify_plugin_secret()` | middleware.py | Backend secret validation |

---

## Appendix B: Configuration Locations

| Setting | Location | Expected Value |
|---------|----------|----------------|
| Plugin Secret | Backend `.env` | `ACM2_PLUGIN_SECRET=sk_plugin_8f545...` |
| Plugin Secret | `wp-config.php` | `define('ACM2_PLUGIN_SECRET', 'sk_plugin_8f545...')` |
| Plugin Secret | `wp_options` | Should match above or be absent |
| API Base URL | Plugin settings | `https://api.apicostx.com` |

---

*End of Report*
