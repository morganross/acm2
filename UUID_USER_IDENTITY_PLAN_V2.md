# UUID User Identity Implementation Plan v2

## Requirements

1. Destroy, delete, remove, replace, kill with extreme prejudice any hint, trace, concept, or evidence of bland usernames in the backend database
2. Use exclusively UUIDs in the backend database—for presets, preset executions, individual runs, and now for user identity
3. Do not store lame or bland usernames in any way
4. Find, identify, locate any code logic or function that deals with user creation or related code—search broadly and deeply
5. Report on needed changes in chat—do not edit code
6. Respond in plain English
7. Include info on how to change the frontend to accommodate
8. WordPress may use bland usernames internally, but we match them to our UUID at the lowest possible level, earliest possible time, bit for bit, byte for byte
9. At no time, never ever, will the bland username be sent to the backend. We do not use or send or receive that username. The change happens at such a low level that there is no matching on the frontend. When webpage code asks WordPress "who is the logged in user?" WordPress answers with the UUID. There is no matching logic between WordPress usernames and UUIDs. ACM uses UUID only.

## Key Design Decisions

- **Frontend generates the UUID** — WordPress plugin creates the UUID at user creation time, before calling the backend
- **Fresh install** — No migration of existing data; all databases start empty
- **No `wordpress_user_id`** — The UUID is the only identifier passed to the backend
- **No `username`** — Never sent, never stored, never returned

---

## Summary

When WordPress creates a new user:
1. WordPress plugin generates a UUID immediately
2. WordPress stores the UUID in its own user meta
3. WordPress sends the UUID to the backend (no username, no wordpress_user_id)
4. Backend creates `user_{uuid}.db` and returns an API key
5. WordPress stores the API key
6. All subsequent requests use the UUID via the API key

The bland username never leaves WordPress core.

---

## Data Flow

```
WordPress User Created
        │
        ▼
┌─────────────────────────────┐
│ Plugin generates UUID       │
│ $uuid = wp_generate_uuid4() │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│ Plugin stores UUID in WP    │
│ update_user_meta(           │
│   $user_id,                 │
│   'acm2_uuid',              │
│   $uuid                     │
│ )                           │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│ Plugin calls backend        │
│ POST /api/v1/users          │
│ Body: { "uuid": $uuid }     │
│ No username. No WP user ID. │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│ Backend receives UUID       │
│ Creates user_{uuid}.db      │
│ Generates API key           │
│ Returns API key             │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│ Plugin stores API key in WP │
│ wp_acm2_api_keys table      │
│ or user meta                │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│ User visits ACM page        │
│ Plugin reads UUID from meta │
│ Plugin reads API key        │
│ Injects into JavaScript     │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│ Browser calls backend       │
│ X-ACM2-API-Key header       │
│ Backend extracts UUID       │
│ Opens user_{uuid}.db        │
└─────────────────────────────┘
```

---

## Backend Changes

### 1. `CreateUserRequest` Model

**Current:**
```python
class CreateUserRequest(BaseModel):
    username: str
    email: EmailStr
    wordpress_user_id: Optional[int] = None
```

**New:**
```python
class CreateUserRequest(BaseModel):
    uuid: str  # UUID generated by frontend
    email: Optional[EmailStr] = None  # Optional, for notifications only
```

### 2. `CreateUserResponse` Model

**Current:**
```python
class CreateUserResponse(BaseModel):
    user_id: int
    username: str
    email: str
    api_key: str
    message: str
```

**New:**
```python
class CreateUserResponse(BaseModel):
    uuid: str
    api_key: str
    message: str
```

### 3. User Database Naming

**Current:** `data/user_6.db` (integer-based)

**New:** `data/user_550e8400-e29b-41d4-a716-446655440000.db` (UUID-based)

### 4. API Key Format

**Current:** `acm2_u6_randomstring` (embeds integer)

**New:** `acm2_{uuid}_randomstring` or `acm2_{uuid_prefix}_randomstring`

### 5. `user_meta` Table Schema

**Current:**
```python
username: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
email: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
```

**New:**
```python
uuid: Mapped[str] = mapped_column(String(36), nullable=False, unique=True)
email: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
# No username column
```

### 6. Auth Middleware

**Current:** Returns `{ 'id': user_id, 'username': ..., 'email': ... }`

**New:** Returns `{ 'uuid': uuid, 'email': ... }`

### 7. User Registry

**Current:** Maps integer `user_id` → database path

**New:** Maps UUID string → database path

---

## Frontend Changes (WordPress Plugin)

### 1. `class-user-sync.php`

**Current:** Sends `username`, `email`, `wordpress_user_id`

**New:**
```php
public static function sync_new_user($wp_user_id) {
    // Generate UUID immediately
    $uuid = wp_generate_uuid4();
    
    // Store UUID in WordPress user meta
    update_user_meta($wp_user_id, 'acm2_uuid', $uuid);
    
    // Get user email (optional)
    $user = get_userdata($wp_user_id);
    $email = $user->user_email;
    
    // Call backend with UUID only
    $response = wp_remote_post($api_url . '/users', [
        'body' => json_encode([
            'uuid' => $uuid,
            'email' => $email,  // Optional
        ]),
        'headers' => [
            'Content-Type' => 'application/json',
            'X-ACM2-Plugin-Secret' => $plugin_secret,
        ],
    ]);
    
    // Store returned API key
    $body = json_decode(wp_remote_retrieve_body($response), true);
    $api_key = $body['api_key'];
    acm2_save_user_api_key($wp_user_id, $api_key);
}
```

### 2. `class-react-app.php`

**Current:**
```php
'currentUser' => wp_get_current_user()->user_login,
```

**New:**
```php
'userUuid' => get_user_meta(get_current_user_id(), 'acm2_uuid', true),
```

Or remove `currentUser` entirely if the React app doesn't need to display it.

### 3. `acm2_get_user_api_key()`

**No change needed** — This function already maps `wp_user_id` to API key. The UUID is stored separately in user meta.

### 4. New Helper Function

```php
function acm2_get_user_uuid($wp_user_id = null) {
    if ($wp_user_id === null) {
        $wp_user_id = get_current_user_id();
    }
    return get_user_meta($wp_user_id, 'acm2_uuid', true);
}
```

---

## React App Changes

### 1. `client.ts` Interface

**Current:**
```typescript
interface Window {
  acm2Config?: {
    apiUrl: string
    apiKey: string
    currentUser: string  // bland username
    nonce: string
  }
}
```

**New:**
```typescript
interface Window {
  acm2Data?: {
    apiUrl: string
    apiKey: string
    userUuid: string  // UUID
    nonce: string
  }
}
```

Or remove `currentUser`/`userUuid` entirely if not used for display.

---

## Files to Modify

### Backend (Python)

| File | Change |
|------|--------|
| `app/api/routes/users.py` | New request/response models, UUID-based user creation |
| `app/infra/db/models/user_meta.py` | Remove `username`, add `uuid` |
| `app/auth/middleware.py` | Return `uuid` instead of `username` |
| `app/auth/user_registry.py` | UUID-based registry |
| `app/auth/api_keys.py` | UUID-based key format |
| `app/infra/db/session.py` | UUID-based database path construction |

### Frontend (WordPress PHP)

| File | Change |
|------|--------|
| `includes/class-user-sync.php` | Generate UUID, send UUID only |
| `admin/class-react-app.php` | Inject `userUuid` instead of `currentUser` |
| `acm2-integration.php` | Add `acm2_get_user_uuid()` helper |

### Frontend (React)

| File | Change |
|------|--------|
| `ui/src/api/client.ts` | Update interface, remove or rename `currentUser` |

---

## What We Are NOT Doing

- ❌ Sending username to backend
- ❌ Storing username in backend
- ❌ Returning username from backend
- ❌ Migrating old data
- ❌ Supporting `wordpress_user_id` mapping
- ❌ Any matching logic between WordPress usernames and UUIDs

---

## Success Criteria

- [ ] Frontend generates UUID at user creation time
- [ ] UUID stored in WordPress user meta immediately
- [ ] Backend receives only UUID (and optional email)
- [ ] Backend creates `user_{uuid}.db`
- [ ] Backend never receives, stores, or returns username
- [ ] API key embeds UUID
- [ ] Auth middleware returns UUID, not username
- [ ] React app receives UUID (or nothing) instead of username
